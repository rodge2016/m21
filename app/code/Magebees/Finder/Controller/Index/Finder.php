<?phpnamespace Magebees\Finder\Controller\Index;use \Magento\Framework\App\Action\Action;class Finder extends Action{	protected $_dropdownsFactory;	protected $_productsFactory;	protected $categoryFactory;		public function __construct(       \Magento\Framework\App\Action\Context $context,       \Magebees\Finder\Model\DropdownsFactory $dropdownsFactory,       \Magebees\Finder\Model\ProductsFactory $productsFactory,	   \Magento\Catalog\Model\CategoryFactory $categoryFactory	) {        parent::__construct($context);        $this->_dropdownsFactory = $dropdownsFactory;        $this->_productsFactory = $productsFactory;		$this->categoryFactory = $categoryFactory;	} 		public function getProductsByCategoryId($categoryId)	{		$category = $this->categoryFactory->create()->load($categoryId);		$skus = $category->getProductCollection()->addAttributeToSelect('sku')										 ->getColumnValues('sku')										;		return $skus;	}		public function execute(){		$options = $this->getRequest()->getParam('selectedValue');		$finderId = $this->getRequest()->getParam('finderId');		$fieldId = $this->getRequest()->getParam('fieldId');		$dropdownId = $this->getRequest()->getParam('dropdownId');		$category_id = $this->getRequest()->getParam('category_id');		$nextDropdownId = $dropdownId + 1;		$selectedvalue=explode("-",$options);								$productsCollection = $this->_productsFactory->create()->getCollection()								->addFieldToFilter('finder_id',$finderId)								;		if($category_id){			$skus = $this->getProductsByCategoryId($category_id);			$productsCollection->addFieldToFilter('sku',array('in'=>$skus));		}										for($i=0;$i<count($selectedvalue);$i++)	{			$fieldload="field".($i+1);			$productsCollection->addFieldToFilter("field".($i+1),$selectedvalue[$i]);		}				if($i<=count($selectedvalue)){			$fieldstring="field".($i+1);		}else{			$fieldstring="field".$i;		}				$dropdown_data = $this->_dropdownsFactory->create()->load($nextDropdownId);		$productsCollection->setOrder($fieldstring,$dropdown_data->getSort());											if ($productsCollection->count()) {				$fieldno="field".($fieldId+1);			$dropdown = "<option value=''>Please select..</option>";			$result=array();			$productarray=array();			foreach($productsCollection as $product){				$key= $product[$fieldno];				if(!array_key_exists($key,$productarray)){					$result[]=array("id"=>$key, "name"=> $key);					$productarray[$key]=$key;				}			} 		}					$this->getResponse()->representJson(            $this->_objectManager->get('Magento\Framework\Json\Helper\Data')->jsonEncode($result)        );	}}